<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="css/tetrisstyle.css" />
  </head>

  <body>
    <div id="game">
      <div class="tetris">T E T R I S</div>
      <div class="field">
        <div class="fieldleft">
          <table id="fieldGame"></table>
        </div>
        <div class="fieldright">
          <div class="rules">
            <div style="margin-bottom: 20px">Правила игры</div>
            <div>&uarr; - поворот фигуры</div>
            <div>&larr; - сдвиг влево</div>
            <div>&rarr; - сдвиг вправо</div>
            <div>&darr; - уронить фигуру</div>
            <div>'Esc' - прекратить игру</div>
            <div>'Spacebar' - пауза</div>
          </div>
          <div class="points">
            <div class="rec">Ваш рекорд:</div>
            <div id="rec"></div>
            <div class="numelem">Блок в игре</div>
            <div id="numElem"></div>
            <div class="speed">текущая скорость</div>
            <div id="speed"></div>
          </div>
        </div>
      </div>
      <div class="startgame" onclick="preStart();">Начать новую игру</div>
      <div id="endGame">
        Игра закончена
        <div>Ваш рекорд:</div>
        <div id="rec1"></div>
      </div>
      <div id="pause">Пауза</div>
    </div>
    <script>
      "use strict";

      let I = [
        [0, 0, 0, 0],
        [1, 1, 1, 1],
        [0, 0, 0, 0],
        [0, 0, 0, 0],
      ];
      let J = [
        [2, 0, 0],
        [2, 2, 2],
        [0, 0, 0],
      ];
      let L = [
        [0, 0, 3],
        [3, 3, 3],
        [0, 0, 0],
      ];
      let O = [
        [4, 4],
        [4, 4],
      ];
      let S = [
        [0, 5, 5],
        [5, 5, 0],
        [0, 0, 0],
      ];
      let Z = [
        [6, 6, 0],
        [0, 6, 6],
        [0, 0, 0],
      ];
      let T = [
        [0, 7, 0],
        [7, 7, 7],
        [0, 0, 0],
      ];
      let figures = [I, J, L, O, S, Z, T];
      let randomF; //случайный элемент из массива фигур
      let figure; //текущая фигура
      let startSpeed = 500; //начальная скорость
      let rec = 0; //рекорд игры
      document.getElementById("rec").innerHTML = rec;
      let numElem = 0; //номер элемента
      document.getElementById("numElem").innerHTML = numElem;
      let speed = 10; //скорость
      document.getElementById("speed").innerHTML = speed;
      let fieldGame = document.getElementById("fieldGame");
      let posX = 4; //начальное положение фигуры / сдвиг фигуры
      let posY = 0; //начальное положение фигуры / сдвиг фигуры
      let stop = false; //признак остановки игры
      let sleep = true; //пауза в игре
      let endG; //заставка конца игры
      let fieldClone = []; //массив поля игры
      let ms; //длина паузы
      field();
      clear();

      function clear() {
        for (let i = 0; i <= 9; i++) {
          fieldClone[i] = [];
          for (let j = 0; j <= 19; j++) {
            fieldClone[i][j] = 0;
            fieldGame.rows[j].cells[i].style.backgroundColor = "#BBBBBB";
          }
        }
      }

      function preStart() {
        numElem = 0;
        document.getElementById("numElem").innerHTML = numElem;
        stop = false;
        start();
      }

      function start() {
        if (stop) return;
        //установка фигуры ------------------------------------------
        randomF = Math.floor(Math.random() * figures.length);
        figure = figures[randomF];
        posX = 4;
        posY = 0;
        for (let i = 0; i < figure.length; i++) {
          for (let j = 0; j < figure[1].length; j++) {
            if (figure[i][j] !== 0 && fieldClone[i + posX][j + posY] > 0) {
              numElem -= 1;
              endGames(endEnd);
            }
            if (figure[i][j] == 1) {
              fieldGame.rows[j].cells[i + 4].style.backgroundColor = "#FF0000";
            }
            if (figure[i][j] == 2) {
              fieldGame.rows[j].cells[i + 4].style.backgroundColor = "#FF4500";
            }
            if (figure[i][j] == 3) {
              fieldGame.rows[j].cells[i + 4].style.backgroundColor = "#FFFF00";
            }
            if (figure[i][j] == 4) {
              fieldGame.rows[j].cells[i + 4].style.backgroundColor = "#00FF00";
            }
            if (figure[i][j] == 5) {
              fieldGame.rows[j].cells[i + 4].style.backgroundColor = "#00FFFF";
            }
            if (figure[i][j] == 6) {
              fieldGame.rows[j].cells[i + 4].style.backgroundColor = "#0000FF";
            }
            if (figure[i][j] == 7) {
              fieldGame.rows[j].cells[i + 4].style.backgroundColor = "#800080";
            }
          }
        }
        lowSpeedDown(lowDown);
      }

      function field() {
        for (let y = 1; y <= 20; y++) {
          let row = "<tr>";
          for (let x = 1; x <= 10; x++) {
            row += '<td class="cage">';
          }
          row += "</tr>";
          fieldGame.innerHTML += row;
        }
      }

      document.addEventListener("keydown", function (event) {
        if (event.keyCode == 37) posLeft(posY); //сдвиг влево
        if (event.keyCode == 39) posRight(posY); //сдвиг вправо
        if (event.keyCode == 38) posTurn(); //поворот фигуры
        if (event.keyCode == 40) highSpeedDown(speedDown); //падение фигуры
        if (event.keyCode == 27) endGames(endEnd); //конец игры
        if (event.keyCode == 32) pauseGame(3000); //пауза
        //if (event.keyCode !== 0) sleep = true; //пауза
      });

      function endGames(endEnd) {
        endG = document.getElementById("endGame");
        if (rec < numElem) rec = numElem;
        document.getElementById("rec1").innerHTML = rec;
        clear();
        stop = true;
        endG.style.visibility = "visible";
        setTimeout(endEnd, 3000);
      }

      function endEnd() {
        if (rec < numElem) rec = numElem;
        document.getElementById("rec").innerHTML = rec;
        endG.style.visibility = "hidden";
        numElem = 0;
        document.getElementById("numElem").innerHTML = numElem;
        for (let i = 0; i <= 9; i++) {
          fieldClone[i] = [];
          for (let j = 0; j <= 19; j++) {
            fieldClone[i][j] = 0;
            fieldGame.rows[j].cells[i].style.backgroundColor = "#BBBBBB";
          }
        }
      }

      function posLeft(posY) {
        let leftX;
        label: for (let i = 0; i < figure.length; i++) {
          for (let j = 0; j < figure[i].length; j++) {
            if (figure[i][j] > 0) {
              leftX = i;
              break label;
            }
          }
        }
        if (posX + leftX > 0) posX -= 1;
        updating();
        drowing(posX, posY);
      }

      function posRight(posY) {
        let rightX;
        label: for (let i = 0; i < figure.length; i++) {
          for (let j = figure.length - 1; j >= 0; j--) {
            if (figure[i][j] !== 0) {
              rightX = i;
              continue label;
            }
          }
        }
        if (posX < fieldClone.length - rightX - 1) posX += 1;
        updating();
        drowing(posX, posY);
      }

      function lowSpeedDown(lowDown) {
        if (stop) return;
        setTimeout(lowDown, startSpeed);
      }

      function lowDown() {
        if (stop) return;
        posY += 1;
        console.log(startSpeed);
        console.log(posY);
        for (let i = 0; i < figure.length; i++) {
          for (let j = 0; j < figure[i].length; j++) {
            let crash =
              figure[i][j] !== 0 && fieldClone[i + posX][j + posY] !== 0;
            if (crash) {
              for (let i = 0; i < figure.length; i++) {
                for (let j = 0; j < figure[i].length; j++) {
                  if (figure[i][j] !== 0)
                    fieldClone[posX + i][posY - 1 + j] = figure[i][j];
                }
              }
              deletedLine(fieldClone);
              console.table(fieldClone);
              posX = 4;
              posY = -1;
              numElem += 1;
              document.getElementById("numElem").innerHTML = numElem;
              start();
              return false;
            }
          }
        }
        updating();
        drowing(posX, posY);
        lowSpeedDown(lowDown);
      }

      function highSpeedDown(speedDown) {
        if (stop) return;
        setTimeout(speedDown, 0);
      }

      function speedDown() {
        if (stop) return;
        posY += 1;
        console.log(posY);
        for (let i = 0; i < figure.length; i++) {
          for (let j = 0; j < figure[i].length; j++) {
            let crash =
              figure[i][j] !== 0 && fieldClone[i + posX][j + posY] !== 0;
            if (crash) {
              for (let i = 0; i < figure.length; i++) {
                for (let j = 0; j < figure[i].length; j++) {
                  if (figure[i][j] !== 0)
                    fieldClone[posX + i][posY - 1 + j] = figure[i][j];
                }
              }
              deletedLine(fieldClone);
              console.table(fieldClone);
              posX = 4;
              posY = -1;
              numElem += 1;
              document.getElementById("numElem").innerHTML = numElem;
              start();
              return false;
            }
          }
        }
        updating();
        drowing(posX, posY);
        highSpeedDown(speedDown);
      }

      function posTurn() {
        let turnT = [];
        for (let i = 0; i < figure.length; i++) {
          turnT[i] = [];
          for (let j = 0; j < figure[i].length; j++) {
            turnT[i][j] = figure[j][figure[i].length - 1 - i];
            if (fieldClone[i + posX][j + posY] == undefined) return;
          }
        }
        figure = turnT;
        return figure;
      }

      function deletedLine(fieldClone) {
        label1: for (let j = 19; j >= 0; j--) {
          let line;
          for (let i = 0; i <= 9; i++) {
            if (fieldClone[i][j] == 0) {
              continue label1;
            } else {
              line = j;
            }
          }
          console.log("++++++++++++++++++++++++++++++");
          for (let j = line; j >= 19 - line - 1; j--) {
            for (let i = 0; i <= 9; i++) {
              if (fieldClone[i][j - 1] == undefined) {
                fieldClone[i][j - 1] = 0;
              }
              fieldClone[i][j] = fieldClone[i][j - 1];
            }
          }
        }
        updating();
        return fieldClone;
      }

      function updating() {
        for (let i = 0; i <= 9; i++) {
          for (let j = 0; j <= 19; j++) {
            if (fieldClone[i][j] == 0) {
              fieldGame.rows[j].cells[i].style.backgroundColor = "#BBBBBB";
            }
          }
        }
        for (let i = 0; i <= 9; i++) {
          for (let j = 0; j <= 19; j++) {
            if (fieldClone[i][j] == 1) {
              fieldGame.rows[j].cells[i].style.backgroundColor = "#FF0000";
            }
            if (fieldClone[i][j] == 2) {
              fieldGame.rows[j].cells[i].style.backgroundColor = "#FF4500";
            }
            if (fieldClone[i][j] == 3) {
              fieldGame.rows[j].cells[i].style.backgroundColor = "#FFFF00";
            }
            if (fieldClone[i][j] == 4) {
              fieldGame.rows[j].cells[i].style.backgroundColor = "#00FF00";
            }
            if (fieldClone[i][j] == 5) {
              fieldGame.rows[j].cells[i].style.backgroundColor = "#00FFFF";
            }
            if (fieldClone[i][j] == 6) {
              fieldGame.rows[j].cells[i].style.backgroundColor = "#0000FF";
            }
            if (fieldClone[i][j] == 7) {
              fieldGame.rows[j].cells[i].style.backgroundColor = "#800080";
            }
          }
        }
      }

      function drowing(posX, posY) {
        for (let i = 0; i < figure.length; i++) {
          for (let j = 0; j < figure[i].length; j++) {
            if (figure[i][j] == 1) {
              fieldGame.rows[j + posY].cells[i + posX].style.backgroundColor =
                "#FF0000";
            }
            if (figure[i][j] == 2) {
              fieldGame.rows[j + posY].cells[i + posX].style.backgroundColor =
                "#FF4500";
            }
            if (figure[i][j] == 3) {
              fieldGame.rows[j + posY].cells[i + posX].style.backgroundColor =
                "#FFFF00";
            }
            if (figure[i][j] == 4) {
              fieldGame.rows[j + posY].cells[i + posX].style.backgroundColor =
                "#00FF00";
            }
            if (figure[i][j] == 5) {
              fieldGame.rows[j + posY].cells[i + posX].style.backgroundColor =
                "#00FFFF";
            }
            if (figure[i][j] == 6) {
              fieldGame.rows[j + posY].cells[i + posX].style.backgroundColor =
                "#0000FF";
            }
            if (figure[i][j] == 7) {
              fieldGame.rows[j + posY].cells[i + posX].style.backgroundColor =
                "#800080";
            }
          }
        }
      }

      function pauseGame(ms) {
        sleep = !sleep;
        console.log(sleep);
        let date;
        let currentDate;
        sleepGame(ms);

        //const date = Date.now();
        function sleepGame(ms) {
          date = Date.now();
          currentDate = null;
          do {
            currentDate = Date.now();
            //if (sleep) break;
          } while (currentDate - date < ms);
        }
        console.log(sleep);
        if (sleep) sleepGame();
      }
    </script>
  </body>
</html>
